{{{ #Windows Malware Detection
	1. Research
		- File.net 
	2. Look into suspicious files names
		- Name
			$ wmic process get name | findstr /vr "ApplicationFrameHost.exe GoogleCrashHandler.exe GoogleCrashHandler64.exe Memory Compression MsMpEng.exe NisSrv.exe Registry RuntimeBroker.exe SearchApp.exe SearchIndexer.exe SecurityHealthService.exe SecurityHealthSystray.exe SettingSyncHost.exe SgrmBroker.exe ShellExperienceHost.exe StartMenuExperienceHost.exe System System Idle Process SystemSettings.exe TextInputHost.exe UserOOBEBroker.exe VGAuthService.exe WMIC.exe WmiPrvSE.exe YourPhone.exe cmd.exe conhost.exe csrss.exe ctfmon.exe dllhost.exe dwm.exe explorer.exe fontdrvhost.exe lsass.exe msdtc.exe services.exe sihost.exe smss.exe spoolsv.exe svchost.exe taskhostw.exe vm3dservice.exe vmtoolsd.exe vpnagent.exe vpnui.exe wininit.exe winlogon.exe findstr.exe SearchProtocolHost.exe SearchFilterHost.exe"
		- ExecutablePath
			$ wmic process get ExecutablePath | findstr /vir "C:\\WINDOWS\\Explorer.EXE C:\\WINDOWS\\System32\\Wbem\\WMIC.exe C:\\WINDOWS\\System32\\svchost.exe C:\\WINDOWS\\system32\\ApplicationFrameHost.exe C:\\WINDOWS\\system32\\SettingSyncHost.exe C:\\WINDOWS\\system32\\cmd.exe C:\\WINDOWS\\system32\\conhost.exe C:\\WINDOWS\\system32\\sihost.exe C:\\WINDOWS\\system32\\svchost.exe C:\\WINDOWS\\system32\\taskhostw.exe C:\\Windows\\System32\\RuntimeBroker.exe C:\\Windows\\System32\\SecurityHealthSystray.exe C:\\Windows\\System32\\oobe\\UserOOBEBroker.exe C:\\Windows\\System32\\smartscreen.exe"
		
	3. Use a sandbox environment
		- No
	4. Download executables
		- Rename .exe .ex_
	5. Find DLLs 
		$ tasklist /m
	6. Inspect open file handles 
		$ handle -p yeet.exe
		$ handle -a # all
		- WinInet.dll is for networking (http, ftp)
		- TODO: Automate This
	7. Check common registry locations
		- MSF
			$ reg eunumkey -k "HKLM\\Software\\Microsoft\\CurrentVersion\\Run"			#Query Key 
			$ reg eunumkey -s "HKLM\\Software\\Microsoft\\CurrentVersion\\Run"			#Query Keys and substrings
			$ reg eunumkey -k "HKLM\\Software\\Microsoft\\CurrentVersion\\Run -v yee"	#Query Specfic Value
	8. Find ports listening for network communications
		$ run uploadexec -e /root/fport.exe -r -v	#Check currently open ports
	9. Inspect suspicious timestamps
		$ shell
			$ dir C:\* /S /T:W | find "10/29/2010 11:39"
		$ search -f SusFile.pf 
	10. Check for unsigned files
		$ run uploadexec -e /root/sigcheck C:\\windows\\yeet.exe 	#File Check  
		$ run uploadexec -e /root/sigcheck -u C:\\windows\\system32\\drivers > C:\\windows\\temp\\sigcheck.txt	#Dir Check
	11. Verify file hashes
		$ root@unix: 
	12. Check for promisc mode
		$ run uploadexec -e /root/promiscdetect.exe -r -v
	13. Use a hex editor
		- strings for...
			- FtpGetFile
			- HttpSendRequest
			- ([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
			- TODO: Look into sysinternals strings tool
	14. Dump the memory
		$ run process_memdump -p 1008
		$ strings 1.1.1.1_svchost.exe_1008_20121012.1234.dmp | grep metsrv
		- TODO: automate this
	15. Report your findings

}}} #
{{{ #Triage 
	{{{ #Networking
		- Generic
			$ netstat
		- Check currently open ports
			$ run uploadexec -e /root/fport.exe -r -v	
		- Check for promisc mode
			$ run uploadexec -e /root/promiscdetect.exe -r -v
		
	}}} #
	{{{ #Registry  
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx"
reg eunumkey -k "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
reg eunumkey -k "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce"
reg eunumkey -k "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders"
reg eunumkey -k "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellFolders"
reg eunumkey -k "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellFolders"
reg eunumkey -k "HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx"
reg eunumkey -k "HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run"
reg eunumkey -k "HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce"
reg eunumkey -k "HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders"
reg eunumkey -k "HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders"
reg eunumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellFolders"
reg eunumkey -k "HKCU\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellFolders"
reg enumkey -k "HKLM\\Software\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs"

	}}} #
	{{{ #Processes
		- Generic 
			$ tasklist 
			$ tasklist /m /FO CSV | findstr /r ".*WinInet.dll.*"
			$ run post/windows/gather/wmic_command COMMAND="process get ExecutablePath"
			$ run post/windows/gather/wmic_command COMMAND="process get Name"
				$ PsExecutablePath=`ls /root/.msf4/loot/ | tail -n 2 | head -n 1`
				$ PsName=`ls /root/.msf4/loot/ | tail -n 1`
				$ cat $PsExecutablePath | egrep "C:\\WINDOWS\\Explorer.EXE|C:\\WINDOWS\\System32\\Wbem\\WMIC.exe|C:\\WINDOWS\\System32\\svchost.exe|C:\\WINDOWS\\system32\\ApplicationFrameHost.exe|C:\\WINDOWS\\system32\\SettingSyncHost.exe|C:\\WINDOWS\\system32\\cmd.exe|C:\\WINDOWS\\system32\\conhost.exe|C:\\WINDOWS\\system32\\sihost.exe|C:\\WINDOWS\\system32\\svchost.exe|C:\\WINDOWS\\system32\\taskhostw.exe|C:\\Windows\\System32\\RuntimeBroker.exe|C:\\Windows\\System32\\SecurityHealthSystray.exe|C:\\Windows\\System32\\oobe\\UserOOBEBroker.exe|C:\\Windows\\System32\\smartscreen.exe"
				$ cat $Name | egrep "ApplicationFrameHost.exe|GoogleCrashHandler.exe|GoogleCrashHandler64.exe|Memory|Compression|MsMpEng.exe|NisSrv.exe|Registry|RuntimeBroker.exe|SearchApp.exe|SearchIndexer.exe|SecurityHealthService.exe|SecurityHealthSystray.exe|SettingSyncHost.exe|SgrmBroker.exe|ShellExperienceHost.exe|StartMenuExperienceHost.exe|System|System|Idle|Process|SystemSettings.exe|TextInputHost.exe|UserOOBEBroker.exe|VGAuthService.exe|WMIC.exe|WmiPrvSE.exe|YourPhone.exe|cmd.exe|conhost.exe|csrss.exe|ctfmon.exe|dllhost.exe|dwm.exe|explorer.exe|fontdrvhost.exe|lsass.exe|msdtc.exe|services.exe|sihost.exe|smss.exe|spoolsv.exe|svchost.exe|taskhostw.exe|vm3dservice.exe|vmtoolsd.exe|vpnagent.exe|vpnui.exe|wininit.exe|winlogon.exe|findstr.exe|SearchProtocolHost.exe|SearchFilterHost.exe"
			
		{{{ #Backup Wmic
		- Name
			$ wmic process get name | findstr /vr "ApplicationFrameHost.exe GoogleCrashHandler.exe GoogleCrashHandler64.exe Memory Compression MsMpEng.exe NisSrv.exe Registry RuntimeBroker.exe SearchApp.exe SearchIndexer.exe SecurityHealthService.exe SecurityHealthSystray.exe SettingSyncHost.exe SgrmBroker.exe ShellExperienceHost.exe StartMenuExperienceHost.exe System System Idle Process SystemSettings.exe TextInputHost.exe UserOOBEBroker.exe VGAuthService.exe WMIC.exe WmiPrvSE.exe YourPhone.exe cmd.exe conhost.exe csrss.exe ctfmon.exe dllhost.exe dwm.exe explorer.exe fontdrvhost.exe lsass.exe msdtc.exe services.exe sihost.exe smss.exe spoolsv.exe svchost.exe taskhostw.exe vm3dservice.exe vmtoolsd.exe vpnagent.exe vpnui.exe wininit.exe winlogon.exe findstr.exe SearchProtocolHost.exe SearchFilterHost.exe"
		- ExecutablePath
			$ wmic process get ExecutablePath | findstr /vir "C:\\WINDOWS\\Explorer.EXE C:\\WINDOWS\\System32\\Wbem\\WMIC.exe C:\\WINDOWS\\System32\\svchost.exe C:\\WINDOWS\\system32\\ApplicationFrameHost.exe C:\\WINDOWS\\system32\\SettingSyncHost.exe C:\\WINDOWS\\system32\\cmd.exe C:\\WINDOWS\\system32\\conhost.exe C:\\WINDOWS\\system32\\sihost.exe C:\\WINDOWS\\system32\\svchost.exe C:\\WINDOWS\\system32\\taskhostw.exe C:\\Windows\\System32\\RuntimeBroker.exe C:\\Windows\\System32\\SecurityHealthSystray.exe C:\\Windows\\System32\\oobe\\UserOOBEBroker.exe C:\\Windows\\System32\\smartscreen.exe"
		
		}}} #
	
	}}} #
	{{{ #Disk
		- Unsigned files 
			$ run uploadexec -e /root/sigcheck -u C:\\windows\\system32\\drivers > C:\\windows\\temp\\sigcheck.txt
	
	}}} #

}}} #
{{{ #Prosecution
	- Research 
	- SigCheck
		$ run uploadexec -e /root/sigcheck C:\\windows\\yeet.exe
	- Find Associated Files 
		$ tasklist /m /FO CSV | findstr "3232"
		- handles?
		- Inspect suspicious timestamps
			$ shell
				$ dir C:\* /S /T:W | find "10/29/2010 11:39"
			$ search -f SusFile.pf 
	- Download 
		$ C:\\windows\\yeet.exe /tmp/yeet.ex_
		$ md5sum asdf
		$ strings asdf | egrep "FtpGetFile|HttpSendRequest|([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})"
	- Dump the memory
		$ run process_memdump -p 1008
		$ strings 1.1.1.1_svchost.exe_1008_20121012.1234.dmp | grep metsrv
		
}}} #
	
	
	
	

